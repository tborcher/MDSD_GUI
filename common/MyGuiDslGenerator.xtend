/*
 * generated by Xtext 2.15.0
 */
package gui_proj.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import gui_proj.myGuiDsl.*
import org.eclipse.xtext.naming.IQualifiedNameProvider
//import javax.inject.Inject
import com.google.inject.Inject

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class MyGuiDslGenerator extends AbstractGenerator {

	@Inject extension IQualifiedNameProvider

	var callbacksFileName = ""
	var guiFileName = ""

	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		for (g : resource.allContents.toIterable.filter(Gui)) {
			var isCS = g.target == "WinForms" || g.target == "Both"
			var fqn = g.fullyQualifiedName.toString("/")
			if(isA3) {
				guiFileName = "genGUI_" + g.fullyQualifiedName.toString("/") + ".au3"//wofE fullyqulified name? g.name geht auch?
				callbacksFileName = "callbacks_" + g.fullyQualifiedName.toString("/") + ".au3"
				fsa.generateFile(guiFileName,g.compile)
				fsa.generateFile(callbacksFileName, callbacks(g))
            }
			if(isCS) {
				fsa.generateFile("genGUI_" + fqn + ".cs", g.compile_cs)
				fsa.generateFile("callbacks_" + fqn + ".cs", "hallo")
			}
        }
	}
	
	
	
	def compile(Gui g) ''' 
	#Region include
	;~ general
	#include <GUIConstantsEx.au3>
	#include <WindowsConstants.au3>
	
	;~ ---spezific---
	;~ buttons Checkbox
	#include <ButtonConstants.au3>
	;~ inputfield
	#include <EditConstants.au3>
	;~ Label
	#include <StaticConstants.au3>
	#EndRegion END include
	
	Global «FOR e : g.guiObjects SEPARATOR ',' AFTER '\n'»$«e.name»«ENDFOR»
	
	_initGUI()
	
	GUISetState(@SW_SHOW)
	
	While 1
		$nMsg = GUIGetMsg()
		Switch $nMsg
			Case $GUI_EVENT_CLOSE
				Exit
	
	«FOR e : g.guiObjects»«
		IF e instanceof InputField»«ELSE»		Case $«e.name»
				_«e.name»Func()
	«ENDIF»«ENDFOR»
	
		EndSwitch
	
	WEnd
	

	
	Func _initGUI()
		$«g.name» = GUICreate("«g.titel»", «g.width», «g.height»)
	«FOR e : g.guiObjects»	«e.compile»
	«ENDFOR»EndFunc
	'''
		
		
		
		
	
	//create GUIElements in initGUI
	def compile(GUIElement gE) '''«switch gE {
	TextLabel:   _initGUI_TextLabel(gE)
	InputField:  _initGUI_InputField(gE)
	Button:      _initGUI_Button(gE)
	RadioButton: _initGUI_RadioButton(gE)
	CheckBox:    _initGUI_CheckBox(gE)
	default: 'ERROR'
	}»'''	
	
	
	def String _initGUI_TextLabel(GUIElement gE){
		val d = (gE as TextLabel).description
		return "$" + gE.name + " = GUICtrlCreateLabel(\"" + d.text + "\", " + d.left + ", " + d.top + optionalWidthHeight(d) + ")"
	}
	
	
	def String _initGUI_InputField(GUIElement gE){
		val d = (gE as InputField).description
		return "$" + gE.name + " = GUICtrlCreateInput(\"" + d.text + "\", " + d.left + ", " + d.top + optionalWidthHeight(d) + ")"
	}
	
	def String _initGUI_Button(GUIElement gE){
		val d = (gE as Button).description
		return "$" + gE.name + " = GUICtrlCreateButton(\"" + d.text + "\", " + d.left + ", " + d.top + optionalWidthHeight(d) + ")"
	}
	
	def String _initGUI_RadioButton(GUIElement gE){
		val d = (gE as RadioButton).description
		return "$" + gE.name + " = GUICtrlCreateRadio(\"" + d.text + "\", " + d.left + ", " + d.top + optionalWidthHeight(d) + ")"
	}
	
	def String _initGUI_CheckBox(GUIElement gE){
		val d = (gE as CheckBox).description
		return "$" + gE.name + " = GUICtrlCreateCheckbox(\"" + d.text + "\", " + d.left + ", " + d.top + optionalWidthHeight(d) + ")"
	}
	
	def String optionalWidthHeight(GUIElementDescription gED){
		var ret = ""
		
		if((gED.width == 0)&&(gED.height == 0)){
		}else if((gED.width != 0)&&(gED.height == 0)){
			ret += ", " +  gED.width
		}else if((gED.width != 0)&&(gED.height != 0)){
			ret += ", " +  gED.width + ", " +  gED.height
		}else if((gED.width == 0)&&(gED.height != 0)){
			ret += ", Default, " +  gED.height
		}
		
		ret
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	//===================================Callbacks==========================================================================

	def callbacks(Gui g) '''
	#include <MsgBoxConstants.au3>
	#include "«guiFileName»"
	
	«FOR e : g.guiObjects»«
			IF e instanceof InputField»«ELSE»Func _«e.name»Func()
		MsgBox($MB_SYSTEMMODAL, "«e.name»", "«e.name»")
	EndFunc
	
	«ENDIF»«ENDFOR»
	'''


//--------------------------------


	def compile_cs(Gui g) '''
namespace Â«g.fullyQualifiedNameÂ» {
	partial class Â«g.nameÂ» {
		/// <summary>
		/// Erforderliche Designervariable.
		/// </summary>
		private System.ComponentModel.IContainer components = null;

		/// <summary>
		/// Verwendete Ressourcen bereinigen.
		/// </summary>
		/// <param name="disposing">True, wenn verwaltete Ressourcen gelÃ¶scht werden sollen; andernfalls False.</param>
		protected override void Dispose(bool disposing) {
			if (disposing && (components != null)) {
				components.Dispose();
			}
			base.Dispose(disposing);
		}

		#region Vom Windows Form-Designer generierter Code

		/// <summary>
		/// Erforderliche Methode fÃ¼r die DesignerunterstÃ¼tzung.
		/// Der Inhalt der Methode darf nicht mit dem Code-Editor geÃ¤ndert werden.
		/// </summary>
		private void InitializeComponent() {
Â«Â«Â«			/// Initializer seperate to allow them referencing each other.
			Â«FOR e : g.guiObjects SEPARATOR '\n' AFTER '\n'Â»
				this.Â«e.nameÂ» = new System.Windows.Forms.Â«e.fullyQualifiedNameÂ» ();
			Â«ENDFORÂ»
			this.SuspendLayout();
			Â«FOR e : g.guiObjects SEPARATOR '\n' AFTER '\n'Â»
				Â«e.createMember_csÂ»
			Â«ENDFORÂ»
Â«Â«Â«			/// Outsourced for convenience, but I guess this can be moved into her as well.
			Â«g.createGUIÂ»
			this.ResumeLayout(false);
			this.PerformLayout();
		}

		#endregion

		Â«FOR e : g.guiObjects SEPARATOR '\n\t\t' AFTER '\n'Â»
			private System.Windows.Forms.Â«e.fullyQualifiedNameÂ» Â«e.nameÂ»;
		Â«ENDFORÂ»
	}
}'''


def createMember_cs(GUIElement e)'''Â«Â«Â«//{ Folding mark
// 
// Â«e.nameÂ»
// 
Â«Â«Â«	// Label, CheckBox --> Will discard ".Size" (?)
this.Â«e.nameÂ».AutoSize = true;
Â«Â«Â«	// Button, TextBox, RadioButton, Label, CheckBox
Â«Â«Â«this.Â«e.nameÂ».Location = new System.Drawing.Point(Â«e.leftÂ», Â«e.topÂ»);
Â«Â«Â«	// Button, TextBox, RadioButton, Label, CheckBox (this is required, I think)
this.Â«e.nameÂ».Name = "Â«e.nameÂ»";
Â«Â«Â«	// Button, TextBox, RadioButton, Label, CheckBox
Â«Â«Â«		/// Does Size regenerate based on ".Text" if missing?
Â«Â«Â«this.Â«e.nameÂ».Size = new System.Drawing.Size(Â«e.widthÂ», Â«e.heightÂ»);
Â«Â«Â«	// Button, TextBox, RadioButton, Label, CheckBox
Â«Â«Â«		/// Running number over all elements; Is that really required or implicit from VS?
this.Â«e.nameÂ».TabIndex = SEQNO;
Â«Â«Â«	// Button, RadioButton, Label, CheckBox
Â«Â«Â«	this.Â«e.nameÂ».Text = "Â«e.displayÂ»";
Â«Â«Â«	// Button, CheckBox
this.Â«e.nameÂ».UseVisualStyleBackColor = true;
Â«Â«Â«	// Button, RadioButton, CheckBox
Â«Â«Â«	if e.hasHandler then
Â«Â«Â«		foreach(h in e.handler) do
Â«Â«Â«			this.Â«e.nameÂ».Â«h.typeÂ» += new System.EventHandler(this.Â«h.nameÂ»);
this.Controls.Add(this.Â«e.nameÂ»);
'''//} Folding mark
/* Define Member "e" as
--	name    :str: VariableName >> default: ToLowercase(class) + SEQNO
--	class   :str: Button	or	System.Windows.Forms.Button, if using does not work.
--	left    :int: Position in px from left border
--	top     :int: Position in px from top border
--	width   :int: Size in X-Direction
--	height  :int: Size in Y-Direction >> default seems to be 17
--	display :str: Text to be displayed >> default: $name (if no sideeffects) or null (if the case)
--	handler :xxx: Collection of Callbacks >> default: null
--	parent  :GuiElement: Parent Element >> default: GUI-Root (??)
//*/

def createGUI(Gui g)'''Â«Â«Â«//{ Folding mark
// 
// Â«g.nameÂ»
// 
Â«Â«Â«	/// Default (MinScale, MaxScale)
this.AutoScaleDimensions = new System.Drawing.SizeF(6F, 13F);
Â«Â«Â«	/// Default
this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
this.ClientSize = new System.Drawing.Size(Â«g.widthÂ», Â«g.heightÂ»);
Â«Â«Â«	<<{{assignMember}}>> --> easier done in createMember_cs
Â«Â«Â«	/// Default
this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedSingle;
Â«Â«Â«	/// Default
this.Location = new System.Drawing.Point(200, 200);
this.Name = "Â«g.nameÂ»";
this.Text = "Â«g.nameÂ»";
Â«Â«Â«	//------------
Â«Â«Â«	with GUI gui having 
Â«Â«Â«	--	name    :str: Title of Window
Â«Â«Â«	--	width   :int: Size in X-Direction >> default 300 (?)
Â«Â«Â«	--	height  :int: Size in Y-Direction >> default 300 (?)
'''//}





}






	

